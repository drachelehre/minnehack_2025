<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Business Finder</title>
  <!-- Bootstrap CSS (v4.5) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f9f9f9;
    }
    /* Navbar styling */
    .navbar {
      background-color: #FFA500;
    }
    .navbar-brand {
      font-weight: bold;
    }
    /* Header user info */
    .user-info {
      font-size: 1rem;
    }
    /* Map styling */
    #map {
      width: 100%;
      height: 400px;
      border: 2px solid #FFA500;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    @media (max-width: 576px) {
      #map {
        height: 300px;
      }
    }
    /* Card styling for business list and quests */
    .business-card, .quest-card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #FFA500;
      color: #fff;
      text-align: center;
    }
    .card-body {
      padding: 20px;
    }
    /* Table styling */
    .table th {
      background-color: #FFA500;
      color: #fff;
      text-align: center;
      vertical-align: middle;
    }
    .table td {
      text-align: center;
    }
    /* Pagination styling */
    .pagination {
      justify-content: center;
    }
    .pagination .page-item .page-link {
      background-color: #FFA500;
      border: none;
      color: #fff;
    }
    .pagination .page-item .page-link:hover {
      background-color: #e59400;
      color: #fff;
    }
    /* Dummy ad styling */
    .ad-space {
      background-color: #f0f0f0;
      padding: 10px;
      margin-bottom: 20px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .ad-space img {
      width: 100%;
      height: auto;
      max-width: 150px;
    }
  </style>
</head>
<body>
  <!-- Responsive Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark sticky-top">
    <a class="navbar-brand" href="#">Local Business Finder</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item user-info">
          <!-- Show the username and total stars -->
          <span class="nav-link">
            Welcome, {{ user.username }} (Total Stars: {{ user.total_stars }})
          </span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container with Left Ad, Main Content, and Right Ad -->
  <div class="container mt-4">
    <div class="row">
      <!-- Left Ad Column: Visible on md and up -->
      <div class="col-md-2 d-none d-md-block">
        <div class="ad-space">
          <h5>Ad Space</h5>
          <img src="https://via.placeholder.com/150x300?text=Left+Ad" alt="Left Ad">
        </div>
      </div>
      <!-- Center Content Column -->
      <div class="col-md-8">
        <!-- Map Section -->
        <div id="map"></div>

        <!-- Business List Card -->
        <div class="card business-card">
          <div class="card-header">
            <h4 class="mb-0">Local Businesses</h4>
          </div>
          <div class="card-body">
            <!-- Responsive Table Container -->
            <div class="table-responsive" id="listings"></div>
            <!-- Pagination Controls -->
            <nav>
              <ul id="pagination" class="pagination"></ul>
            </nav>
          </div>
        </div>

        <!-- Weekly Quests Card -->
        <div class="card quest-card">
          <div class="card-header">
            <h4 class="mb-0">Weekly Quests</h4>
          </div>
          <div class="card-body">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Quest</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Visit one new place this week</td>
                  <!-- For dummy purposes, we display a fixed status (0/1). Update later with real logic. -->
                  <td>0/1</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <!-- Right Ad Column: Visible on md and up -->
      <div class="col-md-2 d-none d-md-block">
        <div class="ad-space">
          <h5>Ad Space</h5>
          <img src="https://via.placeholder.com/150x300?text=Right+Ad" alt="Right Ad">
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Business Details & Review -->
  <div class="modal fade" id="businessModal" tabindex="-1" role="dialog" aria-labelledby="businessModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <form id="transactionForm" action="/add-transaction" method="POST" enctype="multipart/form-data">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="businessModalLabel">Business Details</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <!-- Hidden inputs -->
            <input type="hidden" name="location_id" id="modalLocationId" value="" />
            <input type="hidden" name="user_id" value="{{ user.id }}" />
            <!-- Hidden input for review captcha response -->
            <input type="hidden" name="review_captcha_response" id="review_captcha_response" value="">
            <div class="form-group">
              <label for="modalBusinessName">Business Name</label>
              <input type="text" class="form-control" id="modalBusinessName" name="businessName" readonly />
            </div>
            <div class="form-group">
              <label for="modalBusinessType">Type</label>
              <input type="text" class="form-control" id="modalBusinessType" readonly />
            </div>
            <div class="form-group">
              <label for="modalDistance">Distance (miles)</label>
              <input type="text" class="form-control" id="modalDistance" readonly />
            </div>
            <hr />
            <!-- Form to add a transaction -->
            <div class="form-group">
              <label for="photoUpload">Upload a Photo</label>
              <input type="file" class="form-control-file" id="photoUpload" name="photo" accept="image/*" />
            </div>
            <div class="form-group form-check">
              <input type="checkbox" class="form-check-input" id="visitedCheckbox" name="visited" />
              <label class="form-check-label" for="visitedCheckbox">I visited this business</label>
              <small class="form-text text-muted">* Only available if you are within <span id="visitThresholdDisplay"></span> miles.</small>
            </div>
            <div class="form-group">
              <label for="reviewRating">Review Rating</label>
              <select class="form-control" id="reviewRating" name="review_rating">
                <option value="">Select rating</option>
                <option value="1">1 Star</option>
                <option value="2">2 Stars</option>
                <option value="3">3 Stars</option>
                <option value="4">4 Stars</option>
                <option value="5">5 Stars</option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <!-- Instead of immediate submission, we intercept the button's click -->
            <button type="submit" id="submitReviewBtn" class="btn btn-primary">Submit Review</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Review Captcha Modal -->
  <div class="modal fade" id="reviewCaptchaModal" tabindex="-1" role="dialog" aria-labelledby="reviewCaptchaModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="reviewCaptchaModalLabel">Review Captcha Verification</h5>
        </div>
        <div class="modal-body">
          <p class="text-center">Please complete the captcha below to submit your review:</p>
          <!-- Captcha Block for Google -->
          <div class="captcha-block">
            <img class="captcha-img" src="https://upload.wikimedia.org/wikipedia/commons/2/2f/Google_2015_logo.svg" alt="Google">
            <input type="text" id="reviewCaptcha1" placeholder="Enter brand name">
          </div>
          <!-- Captcha Block for Amazon -->
          <div class="captcha-block">
            <img class="captcha-img" src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg" alt="Amazon">
            <input type="text" id="reviewCaptcha2" placeholder="Enter brand name">
          </div>
          <!-- Captcha Block for Meta -->
          <div class="captcha-block">
            <img class="captcha-img" src="https://upload.wikimedia.org/wikipedia/commons/7/7b/Meta_Platforms_Inc._logo.svg" alt="Meta">
            <input type="text" id="reviewCaptcha3" placeholder="Enter brand name">
          </div>
          <div class="modal-error" id="reviewCaptchaError" style="display:none;">One or more answers are incorrect. Please try again.</div>
        </div>
        <div class="modal-footer">
          <button type="button" id="verifyReviewCaptcha" class="btn btn-primary">Solve Captchas</button>
        </div>
      </div>
    </div>
  </div>

  <!-- jQuery, Popper.js, and Bootstrap JS (using CDN) -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <script>
    // Initialize Google Places Autocomplete on the home_address input.
    function initAutocomplete() {
      var input = document.getElementById('home_address');
      new google.maps.places.Autocomplete(input);
    }

    // When the document is ready...
    $(document).ready(function() {
      // Intercept the submission of the review form.
      $(document).on("submit", "#transactionForm", function(event) {
        event.preventDefault();
        console.log("Intercepted review form submission; showing review captcha modal.");
        $("#reviewCaptchaModal").modal({backdrop: 'static', keyboard: false});
      });
      
      // When the "Solve Captchas" button in the review captcha modal is clicked,
      // set the hidden review captcha field and then submit the form.
      $("#verifyReviewCaptcha").click(function() {
        // Dummy logic: always accept the review captcha.
        $("#review_captcha_response").val("solved");
        $("#reviewCaptchaModal").modal("hide");
        console.log("Review captcha solved; submitting review form.");
        $("#transactionForm")[0].submit();
      });
    });
    
    let map;
    // User's stored location from Flask.
    const userPos = {
      lat: parseFloat('{{ user.latitude }}'),
      lng: parseFloat('{{ user.longitude }}')
    };

    // Global variables for data and pagination.
    let allBusinesses = [];
    let filteredBusinesses = [];
    let currentPage = 1;
    const perPage = 10;
    let totalPages = 0;
    // Global variables for multi-select filter.
    let allTypes = [];
    let selectedTypes = []; // array of currently selected types

    // Define a threshold (in miles) for enabling the "visited" checkbox.
    const visitThreshold = 5.0; // change this value as needed
    document.getElementById('visitThresholdDisplay').textContent = visitThreshold;

    // Fetch the complete list of businesses.
    function fetchAllBusinesses() {
      fetch('/businesses_all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: "{{ user.id }}" })
      })
      .then(response => response.json())
      .then(data => {
        allBusinesses = data.businesses;
        // Compute all distinct types and sort them.
        const typesSet = new Set();
        allBusinesses.forEach(business => {
          if (business.type) {
            typesSet.add(business.type);
          }
        });
        allTypes = Array.from(typesSet).sort();
        // By default, select all types.
        selectedTypes = allTypes.slice();
        // Initially, all businesses are shown.
        filteredBusinesses = allBusinesses;
        totalPages = Math.ceil(filteredBusinesses.length / perPage);
        renderPage(1);
        // Add markers for each business.
        filteredBusinesses.forEach(business => {
          createMarker(business, map);
        });
      })
      .catch(error => console.error("Error fetching businesses:", error));
    }

    // Update the global selectedTypes from the checkboxes.
    function updateSelectedTypes() {
      const checkboxes = document.querySelectorAll('.dropdown-item input[type="checkbox"]');
      selectedTypes = [];
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedTypes.push(checkbox.value);
        }
      });
      applyMultiFilter();
    }

    // Filter businesses based on the selected types.
    function applyMultiFilter() {
      if (selectedTypes.length === 0 || selectedTypes.length === allTypes.length) {
        // If none or all are selected, show all businesses.
        filteredBusinesses = allBusinesses;
      } else {
        filteredBusinesses = allBusinesses.filter(business => selectedTypes.includes(business.type));
      }
      currentPage = 1;
      totalPages = Math.ceil(filteredBusinesses.length / perPage);
      renderPage(currentPage);
    }

    // Render a specific page from the filtered data.
    function renderPage(page) {
      currentPage = page;
      const start = (page - 1) * perPage;
      const end = start + perPage;
      const pageBusinesses = filteredBusinesses.slice(start, end);
      renderTable(pageBusinesses);
      renderPagination();
    }

    // Render the table. Each row gets a click event that shows the business modal.
    function renderTable(businesses) {
      const listingsDiv = document.getElementById("listings");
      listingsDiv.innerHTML = "";
      if (businesses.length === 0) {
        listingsDiv.textContent = "No businesses found.";
        return;
      }
      
      const table = document.createElement("table");
      table.className = "table table-hover table-striped table-bordered mb-0";
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      // Column 1: Business Name.
      const thName = document.createElement("th");
      thName.textContent = "Business Name";
      thName.style.verticalAlign = "middle";
      headerRow.appendChild(thName);

      // Column 2: Type.
      const thType = document.createElement("th");
      thType.textContent = "Type";
      thType.style.verticalAlign = "middle";
      headerRow.appendChild(thType);

      // Column 3: Distance.
      const thDistance = document.createElement("th");
      thDistance.textContent = "Distance (miles)";
      thDistance.style.verticalAlign = "middle";
      headerRow.appendChild(thDistance);

      // Column 4: Stars.
      const thStars = document.createElement("th");
      thStars.textContent = "Stars";
      thStars.style.verticalAlign = "middle";
      headerRow.appendChild(thStars);

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      businesses.forEach(business => {
        const row = document.createElement("tr");
        // Attach business data to the row for later retrieval.
        row.dataset.business = JSON.stringify(business);
        // When the row is clicked, show the modal with details.
        row.addEventListener("click", function() {
          showBusinessModal(JSON.parse(this.dataset.business));
        });

        const tdName = document.createElement("td");
        tdName.textContent = business.name || "";
        row.appendChild(tdName);

        const tdType = document.createElement("td");
        tdType.textContent = business.type || "";
        row.appendChild(tdType);

        const tdDistance = document.createElement("td");
        tdDistance.textContent = business.distance ? parseFloat(business.distance).toFixed(1) : "";
        row.appendChild(tdDistance);

        const tdStars = document.createElement("td");
        tdStars.innerHTML = business.stars || "☆☆☆";
        row.appendChild(tdStars);

        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      listingsDiv.appendChild(table);
    }

    // Render Bootstrap pagination.
    function renderPagination() {
      const paginationUl = document.getElementById("pagination");
      paginationUl.innerHTML = "";
      if (currentPage > 1) {
        const prevLi = document.createElement("li");
        prevLi.className = "page-item";
        const prevLink = document.createElement("a");
        prevLink.className = "page-link";
        prevLink.href = "#";
        prevLink.textContent = "Previous";
        prevLink.onclick = function (e) {
          e.preventDefault();
          renderPage(currentPage - 1);
        };
        prevLi.appendChild(prevLink);
        paginationUl.appendChild(prevLi);
      }
      const pageInfoLi = document.createElement("li");
      pageInfoLi.className = "page-item disabled";
      const pageInfoLink = document.createElement("span");
      pageInfoLink.className = "page-link";
      pageInfoLink.textContent = `Page ${currentPage} of ${totalPages}`;
      pageInfoLi.appendChild(pageInfoLink);
      paginationUl.appendChild(pageInfoLi);
      if (currentPage < totalPages) {
        const nextLi = document.createElement("li");
        nextLi.className = "page-item";
        const nextLink = document.createElement("a");
        nextLink.className = "page-link";
        nextLink.href = "#";
        nextLink.textContent = "Next";
        nextLink.onclick = function (e) {
          e.preventDefault();
          renderPage(currentPage + 1);
        };
        nextLi.appendChild(nextLink);
        paginationUl.appendChild(nextLi);
      }
    }

    // Show the modal for the selected business.
    function showBusinessModal(business) {
      // Populate modal fields.
      document.getElementById("modalLocationId").value = business.location_id || "";
      document.getElementById("modalBusinessName").value = business.name || "";
      document.getElementById("modalBusinessType").value = business.type || "";
      document.getElementById("modalDistance").value = business.distance ? parseFloat(business.distance).toFixed(1) : "";

      // Enable or disable the visited checkbox based on distance.
      const visitedCheckbox = document.getElementById("visitedCheckbox");
      const distance = parseFloat(business.distance);
      if (!isNaN(distance) && distance <= visitThreshold) {
        visitedCheckbox.disabled = false;
      } else {
        visitedCheckbox.disabled = true;
        visitedCheckbox.checked = false;
      }

      // Clear any previous file input, review selection, or review captcha.
      document.getElementById("photoUpload").value = "";
      document.getElementById("reviewRating").value = "";
      document.getElementById("review_captcha_response").value = "";

      // Show the business details modal.
      $("#businessModal").modal("show");
    }

    // Create a marker on the map for a business.
    function createMarker(business, mapInstance) {
      if (!business.latitude || !business.longitude) return;
      const marker = new google.maps.Marker({
        map: mapInstance,
        position: { lat: business.latitude, lng: business.longitude },
        title: business.name
      });
      marker.addListener("click", function () {
        // When marker is clicked, show the modal as well.
        showBusinessModal(business);
      });
    }

    // Initialize the Google Map and fetch business data.
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: userPos,
        zoom: 12
      });
      new google.maps.Marker({
        position: userPos,
        map: map,
        title: "Your Stored Location",
        icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
      });
      
      fetchAllBusinesses();
    }
  </script>

  <!-- Google Maps JavaScript API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
</body>
</html>
