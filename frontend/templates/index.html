<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local Business Finder</title>
  <!-- Bootstrap CSS (v4.5) -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f9f9f9;
    }
    /* Navbar styling */
    .navbar {
      background-color: #FFA500;
    }
    .navbar-brand {
      font-weight: bold;
    }
    /* Map styling */
    #map {
      width: 100%;
      height: 400px;
      border: 2px solid #FFA500;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    @media (max-width: 576px) {
      #map {
        height: 300px;
      }
    }
    /* Business card styling */
    .business-card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .card-header {
      background-color: #FFA500;
      color: #fff;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      text-align: center;
    }
    .card-body {
      padding: 20px;
    }
    /* Table styling */
    .table th {
      background-color: #FFA500;
      color: #fff;
      text-align: center;
      vertical-align: middle;
    }
    .table td {
      text-align: center;
    }
    /* Pagination styling */
    .pagination {
      justify-content: center;
    }
    .pagination .page-item .page-link {
      background-color: #FFA500;
      border: none;
      color: #fff;
    }
    .pagination .page-item .page-link:hover {
      background-color: #e59400;
      color: #fff;
    }
    /* Dropdown checkbox styling */
    .dropdown-menu {
      max-height: 200px;
      overflow-y: auto;
    }
    .dropdown-item label {
      margin-bottom: 0;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <!-- Responsive Navbar -->
  <nav class="navbar navbar-expand-md navbar-dark sticky-top">
    <a class="navbar-brand" href="#">Local Business Finder</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <span class="nav-link">Welcome, {{ user.username }}!</span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Main Container -->
  <div class="container mt-4">
    <!-- Map Section -->
    <div id="map"></div>

    <!-- Business List Card -->
    <div class="card business-card">
      <div class="card-header">
        <h4 class="mb-0">Local Businesses</h4>
      </div>
      <div class="card-body">
        <!-- Responsive Table Container -->
        <div class="table-responsive" id="listings"></div>
        <!-- Pagination Controls -->
        <nav>
          <ul id="pagination" class="pagination"></ul>
        </nav>
      </div>
    </div>
  </div>

  <!-- jQuery, Popper.js, and Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  
  <script>
    let map;
    // User's stored location from Flask.
    const userPos = {
      lat: parseFloat('{{ user.latitude }}'),
      lng: parseFloat('{{ user.longitude }}')
    };

    // Global variables for data and pagination.
    let allBusinesses = [];
    let filteredBusinesses = [];
    let currentPage = 1;
    const perPage = 10;
    let totalPages = 0;
    // Global variables for multi-select filter.
    let allTypes = [];
    let selectedTypes = []; // array of currently selected types

    // Fetch the complete list of businesses.
    function fetchAllBusinesses() {
      fetch('/businesses_all', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: "{{ user.id }}" })
      })
      .then(response => response.json())
      .then(data => {
        allBusinesses = data.businesses;
        // Compute all distinct types and sort them.
        const typesSet = new Set();
        allBusinesses.forEach(business => {
          if (business.type) {
            typesSet.add(business.type);
          }
        });
        allTypes = Array.from(typesSet).sort();
        // By default, select all types.
        selectedTypes = allTypes.slice();
        // Initially, all businesses are shown.
        filteredBusinesses = allBusinesses;
        totalPages = Math.ceil(filteredBusinesses.length / perPage);
        renderPage(1);
        // Add markers for each business.
        filteredBusinesses.forEach(business => {
          createMarker(business, map);
        });
      })
      .catch(error => console.error("Error fetching businesses:", error));
    }

    // Update the global selectedTypes from the checkboxes.
    function updateSelectedTypes() {
      const checkboxes = document.querySelectorAll('.dropdown-item input[type="checkbox"]');
      selectedTypes = [];
      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          selectedTypes.push(checkbox.value);
        }
      });
      // Update the dropdown button text.
      const dropdownButton = document.getElementById("typeDropdown");
      if (selectedTypes.length === allTypes.length) {
        dropdownButton.textContent = "Type";
      } else if (selectedTypes.length === 0) {
        dropdownButton.textContent = "None";
      } else {
        dropdownButton.textContent = selectedTypes.join(", ");
      }
      // Apply the filter.
      applyMultiFilter();
    }

    // Filter businesses based on the selected types.
    function applyMultiFilter() {
      if (selectedTypes.length === 0 || selectedTypes.length === allTypes.length) {
        // If none or all are selected, show all businesses.
        filteredBusinesses = allBusinesses;
      } else {
        filteredBusinesses = allBusinesses.filter(business => selectedTypes.includes(business.type));
      }
      currentPage = 1;
      totalPages = Math.ceil(filteredBusinesses.length / perPage);
      renderPage(currentPage);
    }

    // Render a specific page from the filtered data.
    function renderPage(page) {
      currentPage = page;
      const start = (page - 1) * perPage;
      const end = start + perPage;
      const pageBusinesses = filteredBusinesses.slice(start, end);
      renderTable(pageBusinesses);
      renderPagination();
    }

    // Render the table with the Type header containing a multi-select combobox.
    function renderTable(businesses) {
      const listingsDiv = document.getElementById("listings");
      listingsDiv.innerHTML = "";
      if (businesses.length === 0) {
        listingsDiv.textContent = "No businesses found.";
        return;
      }
      
      const table = document.createElement("table");
      table.className = "table table-hover table-striped table-bordered mb-0";
      const thead = document.createElement("thead");
      const headerRow = document.createElement("tr");

      // Column 1: Business Name.
      const thName = document.createElement("th");
      thName.textContent = "Business Name";
      thName.style.verticalAlign = "middle";
      headerRow.appendChild(thName);

      // Column 2: Type with a dropdown combobox using checkboxes.
      const thType = document.createElement("th");
      const dropdownDiv = document.createElement("div");
      dropdownDiv.className = "dropdown";
      dropdownDiv.style.display = "inline-block"; // fill header cell

      // Dropdown button.
      const dropdownButton = document.createElement("button");
      dropdownButton.className = "btn btn-link text-white dropdown-toggle";
      dropdownButton.type = "button";
      dropdownButton.id = "typeDropdown";
      dropdownButton.setAttribute("data-toggle", "dropdown");
      dropdownButton.setAttribute("aria-haspopup", "true");
      dropdownButton.setAttribute("aria-expanded", "false");
      dropdownButton.style.fontWeight = "bold";
      // Set initial text.
      dropdownButton.textContent = selectedTypes.length === allTypes.length ? "Type" : selectedTypes.join(", ");
      dropdownDiv.appendChild(dropdownButton);

      // Dropdown menu.
      const dropdownMenu = document.createElement("div");
      dropdownMenu.className = "dropdown-menu";
      
      // Create a checkbox for each type.
      allTypes.forEach(type => {
        const itemDiv = document.createElement("div");
        itemDiv.className = "dropdown-item";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "type-checkbox";
        checkbox.value = type;
        checkbox.id = "checkbox-" + type;
        // Check if this type is currently selected.
        checkbox.checked = selectedTypes.includes(type);
        // When changed, update the filter.
        checkbox.addEventListener("change", updateSelectedTypes);
        const label = document.createElement("label");
        label.setAttribute("for", "checkbox-" + type);
        label.textContent = type;
        itemDiv.appendChild(checkbox);
        itemDiv.appendChild(label);
        dropdownMenu.appendChild(itemDiv);
      });
      
      dropdownDiv.appendChild(dropdownMenu);
      thType.appendChild(dropdownDiv);
      headerRow.appendChild(thType);

      // Column 3: Distance.
      const thDistance = document.createElement("th");
      thDistance.textContent = "Distance (miles)";
      thDistance.style.verticalAlign = "middle";
      headerRow.appendChild(thDistance);

      thead.appendChild(headerRow);
      table.appendChild(thead);

      // Build table body.
      const tbody = document.createElement("tbody");
      businesses.forEach(business => {
        const row = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = business.name || "";
        row.appendChild(tdName);

        const tdType = document.createElement("td");
        tdType.textContent = business.type || "";
        row.appendChild(tdType);

        const tdDistance = document.createElement("td");
        tdDistance.textContent = business.distance ? parseFloat(business.distance).toFixed(1) : "";
        row.appendChild(tdDistance);

        tbody.appendChild(row);
      });
      table.appendChild(tbody);
      listingsDiv.appendChild(table);
    }

    // Render Bootstrap pagination.
    function renderPagination() {
      const paginationUl = document.getElementById("pagination");
      paginationUl.innerHTML = "";
      if (currentPage > 1) {
        const prevLi = document.createElement("li");
        prevLi.className = "page-item";
        const prevLink = document.createElement("a");
        prevLink.className = "page-link";
        prevLink.href = "#";
        prevLink.textContent = "Previous";
        prevLink.onclick = function (e) {
          e.preventDefault();
          renderPage(currentPage - 1);
        };
        prevLi.appendChild(prevLink);
        paginationUl.appendChild(prevLi);
      }
      const pageInfoLi = document.createElement("li");
      pageInfoLi.className = "page-item disabled";
      const pageInfoLink = document.createElement("span");
      pageInfoLink.className = "page-link";
      pageInfoLink.textContent = `Page ${currentPage} of ${totalPages}`;
      pageInfoLi.appendChild(pageInfoLink);
      paginationUl.appendChild(pageInfoLi);
      if (currentPage < totalPages) {
        const nextLi = document.createElement("li");
        nextLi.className = "page-item";
        const nextLink = document.createElement("a");
        nextLink.className = "page-link";
        nextLink.href = "#";
        nextLink.textContent = "Next";
        nextLink.onclick = function (e) {
          e.preventDefault();
          renderPage(currentPage + 1);
        };
        nextLi.appendChild(nextLink);
        paginationUl.appendChild(nextLi);
      }
    }

    // Create a marker on the map for a business.
    function createMarker(business, mapInstance) {
      if (!business.latitude || !business.longitude) return;
      const marker = new google.maps.Marker({
        map: mapInstance,
        position: { lat: business.latitude, lng: business.longitude },
        title: business.name
      });
      marker.addListener("click", function () {
        const infowindow = new google.maps.InfoWindow({
          content: business.name
        });
        infowindow.open(mapInstance, marker);
      });
    }

    // Initialize the Google Map and fetch business data.
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: userPos,
        zoom: 12
      });
      new google.maps.Marker({
        position: userPos,
        map: map,
        title: "Your Stored Location"
      });
      fetchAllBusinesses();
    }
  </script>

  <!-- Google Maps JavaScript API -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap"></script>
</body>
</html>
